(function(e){function r(e,t){if(t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function i(e,t){if(e.forEach){e.forEach(t);return}for(var n in e)e.hasOwnProperty(n)&&t(e[n])}function s(e,t){if(e.indexOf)return e.indexOf(t);for(var n in e)if(e[n]==t)return n;return-1}function u(e){if(this===window||typeof mozmarket!="undefined"&&this==mozmarket.receipts)return new u(e);e=e||{},this.overlay=null;for(var t in e)if(e.hasOwnProperty(t)&&t!="verifier"&&t!="templates"&&t!="verify"&&t!="verifierOptions"){if(this[t]===undefined)throw"Unknown option: "+t;this[t]=e[t]}if(e.templates){var r=this.templates;this.templates={};for(var t in r)this.templates[t]=r[t];for(var t in e.templates)e.templates.hasOwnProperty(t)&&(this.templates[t]=e.templates[t])}if(!this.storeURL)throw"You must provide a storeURL option";if(!this.supportHTML)throw"You must provide a supportHTML option";e.verifier&&this.respond(e.verifier);if(e.verify){var i=new n(e.verifierOptions),s=this;i.verify(function(){s.respond(i)})}}e.receipts||(e.receipts={});var t=function(){return this}();typeof atob=="undefined"&&typeof Buffer!="undefined"&&(atob=function(e){return(new Buffer(e,"base64")).toString("utf8")});var n=function(e){if(this===t)throw"You forgot new";e=e||{};for(var n in e)if(e.hasOwnProperty(n)&&this._validConstructorArguments.indexOf(n)==-1)throw"Illegal option to Verifier({}): "+n;this.app=undefined,this.products=[],this.receiptErrors={},this.receiptVerifications={},this._cacheStorage=e.cacheStorage||(typeof localStorage!="undefined"?localStorage:undefined),this.cacheTimeout=e.cacheTimeout||this.defaultCacheTimeout,this.state=new this.states.VerificationIncomplete(".verify() has not been called"),this.requestTimeout=e.requestTimeout||this.defaultRequestTimeout,this.refundWindow=e.refundWindow||this.defaultRefundWindow,this.installs_allowed_from=e.installs_allowed_from||undefined,this.onlog=e.onlog,e.logLevel&&(typeof e.logLevel=="string"?this.logLevel=this.levels[e.logLevel]:this.logLevel=e.logLevel)};n.State=function(e,i){if(e===undefined)return this;var s=function(e,n){if(this===t)throw"You forgot new";this.detail=e,r(this,n)};return i===undefined&&(i=n.State),s.prototype=new i,s.className=e,s.prototype.name=e,s},n.State.prototype.toString=function(){var e="["+this.name;this.detail&&(e+=" "+this.detail);for(var t in this)if(this.hasOwnProperty(t)&&t!="detail"){if(typeof this[t]=="object"&&this[t]&&this[t].toSource)var n=this[t].toSource();else var n=JSON.stringify(this[t]);e+=" "+t+": "+n}return e+="]",e},n.states={},n.states.VerificationIncomplete=n.State("VerificationIncomplete"),n.states.NeedsInstall=n.State("NeedsInstall"),n.states.MozAppsNotSupported=n.State("MozAppsNotSupported"),n.states.NetworkError=n.State("NetworkError"),n.states.NotInstalled=n.State("NotInstalled",n.states.NeedsInstall),n.states.NoReceipts=n.State("NoReceipts",n.states.NeedsInstall),n.states.NoValidReceipts=n.State("NoValidReceipts"),n.states.OK=n.State("OK"),n.states.OKCache=n.State("OKCache",n.states.OK),n.states.OKStaleCache=n.State("OKStaleCache",n.states.OKCache),n.states.InternalError=n.State("InternalError"),n.states.MozAppsError=n.State("MozAppsError",n.states.InternalError),n.states.VerifierError=n.State("VerifierError",n.states.InternalError),n.states.ServerError=n.State("ServerError",n.states.NetworkError),n.states.toString=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&t!="toString"&&t!="detail"&&e.push(t);return e.sort(),"{"+e.join(", ")+"}"},n.errors={},n.errors.ReceiptFormatError=n.State("ReceiptFormatError"),n.errors.ReceiptParseError=n.State("ReceiptParseError",n.errors.ReceiptFormatError),n.errors.InvalidFromStore=n.State("InvalidFromStore"),n.errors.Refunded=n.State("Refunded"),n.errors.RequestTimeout=n.State("RequestTimeout",n.states.ServerError),n.errors.ServerStatusError=n.State("ServerStatusError",n.states.ServerError),n.errors.InvalidServerResponse=n.State("InvalidServerResponse",n.states.ServerError),n.errors.InvalidReceiptIssuer=n.State("InvalidReceiptIssuer"),n.errors.ConnectionError=n.State("ConnectionError",n.states.NetworkError),n.errors.ReceiptExpired=n.State("ReceiptExpired"),n.errors.toString=n.states.toString,n.prototype={_validConstructorArguments:["cacheStorage","cacheTimeout","requestTimeout","refundWindow","installs_allowed_from","onlog","logLevel"],defaultCacheTimeout:864e5,defaultRequestTimeout:3e4,defaultRefundWindow:24e5,toString:function(){var e=this,t="[Verifier state: "+this.state;return this.products.length&&(t+=" products: "+this.products.map(function(e){return e.url}).join(", ")),this.iterReceiptErrors(function(n,r){r==e.state?t+=" Error("+n.substr(0,4)+"..."+n.substr(n.length-4)+"): [error is state]":t+=" Error("+n.substr(0,4)+"..."+n.substr(n.length-4)+"): "+r}),this.app&&(t+=" installed app: "+this.app.manifestURL),t+="]",t},iterReceiptErrors:function(e){for(var t in this.receiptErrors)if(this.receiptErrors.hasOwnProperty(t)){var n=e(t,this.receiptErrors[t]);if(n===!1)break}},verify:function(e){var t=this;this.state=new this.states.VerificationIncomplete(".verify() has not completed");if(!navigator.mozApps){this.state=new this.states.MozAppsNotSupported("navigator.mozApps does not exist"),e(t);return}var n=navigator.mozApps.getSelf();n.onsuccess=function(){try{t.app=this.result||null;if(!this.result){t.state=new t.states.NotInstalled("The app is not installed"),e(t);return}t.log(t.levels.INFO,"Got application: "+this.result.manifestURL),t.verifyReceipts(this.result,e)}catch(n){t.state=new t.states.VerifierError("Exception: "+n,{exception:n}),e(t)}},n.onerror=function(){t.state=new t.errors.MozAppsError("Error calling mozApps.getSelf: "+(this.error&&this.error.name),{mozAppsError:this.error}),t.log(t.levels.ERROR,"Got mozApps Error: "+(this.error&&this.error.name)),e(t)}},verifyReceipts:function(e,t){if(!e.receipts||!e.receipts.length){e.receipts===undefined&&this.log(r.levels.ERROR,"The .receipts property of the app object is undefined (app: "+JSON.stringify(e)+")"),this.state=new this.states.NoReceipts("No receipts were found or installed");return}this.installs_allowed_from===undefined&&(this.installs_allowed_from=e.manifest.installs_allowed_from,this.log(this.levels.INFO,"Using installs_allowed_from value from manifest: "+JSON.stringify(this.installs_allowed_from)));var n=e.receipts.length,r=this;i(e.receipts,function(i){r.log(r.levels.DEBUG,"Checking receipt "+i.substr(0,4));var s=r._checkCache(i,!1);if(s){r.log(r.levels.INFO,"Got receipt ("+i.substr(0,4)+") status from cache: "+JSON.stringify(s)),r._addReceiptError(i,new r.states.OKCache),r._addReceiptVerification(i,s),n--,n||r._finishVerification(t);return}try{r._verifyOneReceipt(e,i,function(){n--,n||r._finishVerification(t)})}catch(o){r.log(r.levels.ERROR,"Got error in _verifyOneReceipt: "+o),r._addReceiptError(i,new r.states.VerifierError("Exception in _verifyOneReceipt: "+o,{exception:o})),n--,n||r._finishVerification(t)}})},_finishVerification:function(e){try{this.log(this.levels.DEBUG,"Finished all receipt verification"),this.state instanceof this.states.VerificationIncomplete&&(this.log(this.levels.DEBUG,"No serious errors during verification"),this.products.length?this.state=new this.states.OK:this.state=new this.states.NoValidReceipts("No receipts passed verification")),e(this)}catch(t){this.log(this.levels.ERROR,"Fatal error in _finishVerification: "+t),this.state=new this.states.VerifierError("Exception: "+t,{exception:t}),e(this)}},_verifyOneReceipt:function(e,t,n){try{var r=this.parseReceipt(t)}catch(i){this._addReceiptError(t,new this.errors.ReceiptParseError("Error decoding JSON: "+i,{exception:i})),n();return}var o=r.iss;if(!o){this._addReceiptError(t,new this.errors.ReceiptFormatError("No (or empty) iss field"),{parsed:r}),n();return}if(this.installs_allowed_from&&s(this.installs_allowed_from,o)==-1&&s(this.installs_allowed_from,"*")==-1){this._addReceiptError(t,new this.errors.InvalidReceiptIssuer("Issuer (iss) of receipt is not a valid installer: "+o,{iss:o,installs_allowed_from:this.installs_allowed_from})),n();return}var u=r.verify;if(!u){this._addReceiptError(t,new this.errors.ReceiptFormatError("No (or empty) verify field"),{parsed:r}),n();return}typeof XMLHttpRequest=="undefined"&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest);var a=new XMLHttpRequest,f=this,l=null;this.log(this.levels.INFO,"POSTing to "+u),a.open("POST",u),a.onreadystatechange=function(){if(a.readyState!=4)return;f.log(f.levels.INFO,"Request to "+u+" completed with status: "+a.status),l&&(clearTimeout(l),l=null);if(a.status===0){f._addReceiptError(t,new f.errors.ConnectionError("Server could not be contacted",{request:a,url:u})),n();return}if(a.status==404){f._addReceiptError(t,new f.errors.ServerStatusError("Server responded with 404 to "+u,{request:a,status:a.status,url:u})),n();return}if(a.status!=200){f._addReceiptError(t,new f.errors.ServerStatusError("Server responded with non-200 status: "+a.status,{request:a,status:a.status,url:u})),n();return}try{var e=JSON.parse(a.responseText)}catch(i){f._addReceiptError(t,new f.errors.InvalidServerResponse("Invalid JSON from server",{request:a,text:a.responseText})),n();return}if(typeof e!="object"||e===null){f._addReceiptError(t,new f.errors.InvalidServerResponse("Server did not respond with a JSON object ("+JSON.stringify(e)+")",{request:a,text:a.responseText})),n();return}f.log(f.levels.INFO,"Receipt ("+t.substr(0,4)+"...) completed with result: "+JSON.stringify(e));if(e.status=="ok"||e.status=="pending"){f._addReceiptVerification(t,e),e.status=="ok"&&f._saveResults(t,r,e),n();return}if(e.status=="refunded"){f._addReceiptError(t,new f.errors.Refunded("Application payment was refunded",{result:e})),n();return}if(e.status=="expired"){f._addReceiptError(t,new f.errors.ReceiptExpired("Receipt expired",{result:e})),f._addReceiptVerification(t,e),n();return}if(e.status=="invalid"){f._addReceiptError(t,new f.errors.InvalidFromStore("The store reports the receipt is invalid",{result:e})),n();return}f._addReceiptError(t,new f.errors.InvalidServerResponse("Store replied with unknown status: "+e.status,{result:e})),n()},a.send(t),this.requestTimeout&&(l=setTimeout(function(){a.abort(),f.log(f.levels.ERROR,"Request to "+u+" timed out"),f._addReceiptError(t,new f.errors.RequestTimeout("The request timed out after "+f.requestTimeout+" milliseconds",{request:a,url:u})),n()},this.requestTimeout))},_addReceiptError:function(e,t){this.receiptErrors[e]=t;if(t instanceof this.states.NetworkError){var n=this._checkCache(e,!0);if(n){this.log("Got stale receipt ("+e.substr(0,4)+") status from cache: "+JSON.stringify(n)),this._addReceiptVerification(e,n),this._addReceiptError(e,new this.states.OKStaleCache("Used a stale cache because of network error: "+t));return}}t instanceof this.states.NetworkError?this.state instanceof this.states.VerificationIncomplete&&(this.state=t):t instanceof this.states.OK&&(this.state instanceof this.states.OK||this.state instanceof this.states.VerificationIncomplete)&&(this.state=t)},_addReceiptVerification:function(e,t){this.receiptVerifications[e]=t,this.products.push(this.parseReceipt(e).product)},_checkCache:function(e,t){if(!this._cacheStorage)return null;var n=this._makeKey(e),r=this._cacheStorage.getItem(n);if(!r)return null;try{r=JSON.parse(r)}catch(i){return this._cacheStorage.removeItem(n),null}var s=r.result;if(!t){if(Date.now()-r.created>this.cacheTimeout)return this.log(this.levels.INFO,"Not using cache value because it is expired"),null;if(s.status=="pending")return null;var o=this.parseReceipt(e);return o.iat&&this.refundWindow&&r.created-o.iat<this.refundWindow&&Date.now()-o.iat>this.refundWindow?null:s}return s},_saveResults:function(e,t,n){if(!this._cacheStorage)return;var r=this._makeKey(e),i={created:Date.now(),result:n};this._cacheStorage.setItem(r,JSON.stringify(i))},clearCache:function(){if(!this._cacheStorage)return;var e=[];for(var t=0;t<this._cacheStorage.length;t++){var n=this._cacheStorage.key(t);n.substr(0,16)=="receiptverifier."&&e.push(n)}for(t=0;t<e.length;t++)this._cacheStorage.removeItem(e[t])},_makeKey:function(e){return"receiptverifier."+e},parseReceipt:function(e){if(e.indexOf(".")==-1)throw"Not valid JWT";var t=e.split("~"),n=t[1].split("."),r=n[1];return r=this.base64urldecode(r),r=JSON.parse(r),r},base64urldecode:function(e){e=e.replace(/-/g,"+"),e=e.replace(/_/g,"/");switch(e.length%4){case 0:break;case 1:e+="===";break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}return atob(e)},base64urlencode:function(e){return e=btoa(e),e=e.replace(/\+/g,"-"),e=e.replace(/\//g,"_"),e=e.replace(/[\n=]/g,""),e},levels:{DEBUG:10,INFO:20,NOTIFY:30,WARN:40,ERROR:50},logLevel:2,log:function(e,t){if(!this.onlog||e<this.logLevel)return;this.onlog(e,t)}},n.consoleLogger=function(e,t){if(!console)return;e<=this.levels.DEBUG&&console.debug?console.debug(t):e<=this.levels.INFO&&console.info?console.info(t):e<=this.levels.NOTIFY&&console.log?console.log(t):e<=this.levels.WARN&&console.warn?console.warn(t):console.error?console.error(t):console.log(t)},n.prototype.levels.toString=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&t!="toString"&&e.push(t);var n=this;return e.sort(function(e,t){return n[e]<n[t]?1:-1}),"{"+e.join(", ")+"}"},n.prototype.states=n.states,n.prototype.errors=n.errors,n.prototype.consoleLogger=n.consoleLogger,n.levels=n.prototype.levels,e.receipts.Verifier=n,e.receipts.verify=function(t,r){var i=new n(r);i.verify(t)};var o=function(e,t,n){function r(n){var r,s,o=Array.prototype.forEach;return r=n.nodeType?[n]:t.querySelectorAll(n),r.each=function(e){return o.call(r,function(t){e.call(t)}),r},r.on=function(e,t){return r.each(function(){i(this,e,t)}),r},r.css=function(t){if(typeof t=="object"){for(s in t)r.each(function(){this.style[s]=t[s]});return r}return e.getComputedStyle(r[0]).getPropertyValue(t)},r.attr=function(e){if(typeof e=="object"){for(s in e)r.each(function(){this.setAttribute(s,e[s])});return r}return r[0].getAttribute(e)},r}var i=r.on=function(e,t,n){e.addEventListener(t,function(e){n.call(e.target,e)},!1)};return r}(typeof window!="undefined"?window:global,typeof document!="undefined"?document:undefined);u.prototype={storeURL:null,allowNoInstall:!1,ignoreInternalError:!1,fatalInternalError:!1,supportHTML:null,templates:{fatalInternalError:"We have encountered a error that keeps us from continuing.  Please contact support: <%= supportHTML %>",internalError:"We have encountered an error.  You may close this dialog to continue, but please also contact support: <%= supportHTML %>",storeInstall:'Please visit the <a href="<%= quote(storeURL) %>">store page</a> to install the application.',refunded:'You purchased this app, but then got a refund.  If you still want to use the application, you must <a href="<%= quote(storeURL) %>">purchase the application again</a>.',invalidReceiptIssuer:'You purchased this application from <%= error.iss %> which is not a store we have a relationship with.  Please either <a href="<%= quote(storeURL) %>">re-purchase the application</a> or contact support: <%= supportHTML %>',invalidFromStore:'The store reports that your purchase receipt is invalid.  Please <a href="<%= quote(storeURL) %>">visit the store to reinstall the application</a>.',receiptFormatError:'Your purchase receipt is malformed.  Please <a href="<%= quote(storeURL) %>">visit the store to reinstall the application</a>.',genericError:'An error has occurred.  <a href="<%= quote(storeURL) %>">Reinstalling the application</a> may fix this problem.  If not please contact support: <%= supportHTML %>',mozAppsNotSupported:"This browser or device does not support the Marketplace Apps system."},respond:function(e){this.verifier=e;if(e.state instanceof e.states.VerificationIncomplete)throw window.console&&console.log&&(console.log("Prompter called with verifier",e,"before verification complete"),console.trace&&console.track()),"Prompter called before verification complete";if(e.state instanceof e.states.OK||e.state instanceof e.states.NetworkError)return;if(e.state instanceof e.states.MozAppsNotSupported){this.handleMozAppsNotSupported(e);return}if(e.state instanceof e.states.InternalError){if(this.ignoreInternalError)return;this.handleInternalError(e);return}if(e.state instanceof e.states.NeedsInstall){this.handleInstall(e);return}if(e.state instanceof e.states.NoValidReceipts){var t=null;e.iterReceiptErrors(function(n,r){t===null?t=r:t instanceof e.states.NetworkError&&(t=r)}),this.handleReceiptError(e,t);return}throw window.console&&console.log&&console.log("Unexpected state: "+e.state),"Unexpected state in verifier: "+e.state},handleMozAppsNotSupported:function(e){var t=!this.allowNoInstall;this.display(this.render(this.templates.mozAppsNotSupported),t)},handleInternalError:function(e){this.fatalInternalError?this.display(this.render(this.templates.fatalInternalError),!0):this.display(this.render(this.templates.internalError),!1)},handleInstall:function(e){var t=!this.allowNoInstall;if(this.allowNoInstall&&e.state instanceof e.states.NoReceipts)return;var n=this.templates.storeInstall,r=this.render(n);this.display(r,t)},handleReceiptError:function(e,t){this.error=t;if(t instanceof e.errors.Refunded)var n=this.templates.refunded;else if(t instanceof e.errors.InvalidReceiptIssuer)var n=this.templates.invalidReceiptIssuer;else if(t instanceof e.errors.InvalidFromStore)var n=this.templates.invalidFromStore;else if(t instanceof e.errors.ReceiptFormatError)var n=this.templates.receiptFormatError;else var n=this.templates.genericError;var r=this.render(n);this.display(r,!this.allowNoInstall)},overlayId:"moz-receiptverifier-overlay",generalStyle:"#OVERLAYID-message,#OVERLAYID-message *,#OVERLAYID-message a:hover,#OVERLAYID-message a:visited,#OVERLAYID-message a:active {\n  bottom:auto;clear:none;cursor:default;font-family:Helvetica,Arial,sans-serif;font-size:medium;font-style:normal;font-weight:normal;  height:auto;left:auto;letter-spacing:normal;line-height:1.4;max-height:none;max-width:none;min-height:0;min-width:0;overflow:visible;  right:auto;text-align:left;text-decoration:none;text-indent:0;text-transform:none;top:auto;visibility:visible;white-space:normal;  width:auto;z-index:auto;\n}\n#OVERLAYID-message a {color: #00f;}\n#OVERLAYID-message a:visited {color:#a0f;}\n#OVERLAYID-message a:hover {text-decoration:underline;}\n#OVERLAYID {\n  position:fixed;top:0;left:0;z-index:9999;background:#000;opacity:0.85;width:100%;height:100%;\n}\n#OVERLAYID-message {\n  z-index:1000;position:fixed;top:100px;left:50%;margin-left:-200px;width:400px;padding:0.75em 1em 0.75em 1em;  border:3px solid #ccc;background:#fff;opacity:1.0;color:#000;border-radius:1em;\n}\n#OVERLAYID-close {\n  display:block;position:fixed;top:91px;left:50%;margin-left:227px;z-index:1001;height:0;width:18px;padding:18px 0 0 0;  overflow:hidden;background:#000 none;border:2px solid #fff;border-radius:18px;  box-shadow:0 0 6px #000,1.6px 1.6px 1.6px rgba(0,0,0,0.3),-1.6px 1.6px 1.6px rgba(0,0,0,0.3),1.6px -1.6px 1.6px rgba(0,0,0,0.3),-1.6px -1.6px 1.6px rgba(0,0,0,0.3);  color:#fff;cursor:pointer;user-select:none;\n}\n#OVERLAYID-close-text {\n  display:block;text-align:center;width:18px;top:0px;left:0px;position:absolute;font-size:18px;line-height:18px;\n}\n",createOverlay:function(e){function r(){n.blocking?n.flash():n.removeOverlay()}this.removeOverlay(),this.addStyle(),this.blocking=e,this.overlay=o(document.createElement("div")),this.overlay.attr({id:this.overlayId}),this.message=o(document.createElement("div")),this.message.attr({id:this.overlayId+"-message"}),this.overlay[0].appendChild(this.message[0]);if(!e){this.close=o(document.createElement("div")),this.close.attr({id:this.overlayId+"-close"});var t=o(document.createElement("div"));t.attr({id:this.overlayId+"-close-text"}),t[0].appendChild(document.createTextNode("Ã—")),this.close[0].appendChild(t[0]),this.overlay[0].appendChild(this.close[0])}o("body").css({"z-index":"-1"})[0].appendChild(this.overlay[0]);var n=this;this.overlay.on("click",function(e){var t=e.target;while(t){if(n.message&&t==n.message[0])return;if(n.overlay&&t==n.overlay[0])break;t=t.parentNode}r()}),this.close&&this.close.on("click",function(){r()}),o(document).on("keypress",function(e){e.keyCode==27&&r()})},flash:function(){if(!this.message)return;this.message.css({border:"3px solid #f00"});var e=this;setTimeout(function(){e.message&&e.message.css({border:"3px solid #ccc"})},2e3)},removeOverlay:function(){var e=o("#"+this.overlayId)[0];e&&e.parentNode.removeChild(e),this.overlay=null,this.message=null,this.close=null},addStyle:function(){var e=this.overlayId+"-style",t=o("#"+e);if(t[0])return;var n=document.createElement("style");n.id=e,n.setAttribute("type","text/css");var r=this.generalStyle;r=r.replace(/OVERLAYID/g,this.overlayId),n.appendChild(document.createTextNode(r)),document.head.appendChild(n)},display:function(e,t){this.message||this.createOverlay(t),this.message[0].innerHTML=e},quote:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/"/g,"&quot;")},_templateCache:{},render:function(e,t){t=t||this;if(this._templateCache[e])var n=this._templateCache[e];else{var n=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");this._templateCache[e]=n}return n(t)}},e.receipts.Prompter=u})(typeof exports=="undefined"?this.mozmarket?this.mozmarket:this.mozmarket={}:exports),define("receiptverifier",function(){}),define("install",["require"],function(e){function t(){var e=t[t.type+"Install"];e?e():t.trigger("error","unsupported install: "+t.type)}function n(e){t.state=e,t.trigger("change",t.state)}t.state="unknown",t.check=function(){var e=navigator.mozApps,r;navigator.mozApps?(t.type="mozilla",r=navigator.mozApps.getSelf(),r.onsuccess=function(){this.result?n("installed"):n("uninstalled")},r.onerror=function(e){t.error=e,n("error")}):typeof chrome!="undefined"&&chrome.webstore&&chrome.app?(t.type="chromeStore",chrome.app.isInstalled?n("installed"):n("uninstalled")):typeof window.navigator.standalone!="undefined"?(t.type="ios",window.navigator.standalone?n("installed"):n("uninstalled")):(t.type="unsupported",n("unsupported"))},t.mozillaInstallUrl=location.href+"manifest.webapp",t.mozillaInstall=function(){var e=navigator.mozApps.install(t.mozillaInstallUrl);e.onsuccess=function(e){n("installed")},e.onerror=function(e){t.error=e,n("error")}},t.chromeInstallUrl=null,t.chromeInstall=function(){chrome.webstore.install(t.chromeInstallUrl,function(){n("installed")},function(e){t.error=e,n("error")})},t.iosInstall=function(){t.trigger("showiOSInstall",navigator.platform.toLowerCase())};var r={};return t.on=function(e,t){r[e]=(r[e]||[]).concat([t])},t.off=function(e,t){if(r[e]){var n=[];for(var i=0,s=r[e].length;i<s;i++){var o=r[e][i];o!=t&&n.push()}r[e]=n}},t.trigger=function(e){var t=Array.prototype.slice.call(arguments,1);if(r[e])for(var n=0,i=r[e].length;n<i;n++)r[e][n].apply(this,t)},t.check(),t}),define("../install-button",["require","install"],function(e){function n(){var e=document.getElementById("install-btn");if(t.state=="uninstalled")e.style.display="block";else if(t.state=="installed"||t.state=="unsupported")e.style.display="none"}function r(){var e=document.getElementById("install-btn");e.addEventListener("click",function(){t()}),t.on("change",n),t.on("error",function(e,t){alert("There was an error during installation.")}),t.on("showiOSInstall",function(){alert('To install, press the forward arrow in Safari and touch "Add to Home Screen"')})}var t=e("install");document.getElementById("install-btn")?r():document.addEventListener("DOMContentLoaded",r)}),define("../math",["require"],function(e){function i(e,t,n){return Math.max(Math.min(e,n),t)}var t=typeof Float32Array!="undefined"?Float32Array:Array,n=1e-6,r={};r.create=function(e){var n=new t(2);return e?(n[0]=e[0],n[1]=e[1]):n[0]=n[1]=0,n},r.createFrom=function(e,n){var r=new t(2);return r[0]=e,r[1]=n,r},r.set=function(e,t){return t[0]=e[0],t[1]=e[1],t},r.equal=function(e,t){return e===t||Math.abs(e[0]-t[0])<n&&Math.abs(e[1]-t[1])<n},r.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n)},r.subtract=function(e,t,n){return!n||e===n?(e[0]-=t[0],e[1]-=t[1],e):(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n)},r.multiply=function(e,t,n){return!n||e===n?(e[0]*=t[0],e[1]*=t[1],e):(n[0]=e[0]*t[0],n[1]=e[1]*t[1],n)},r.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n)},r.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},r.str=function(e){return"["+e[0]+", "+e[1]+"]"},window.vec2=r,window.bound=i}),define("../resources",["require"],function(e){function i(e){e instanceof Array?e.forEach(function(e){s(e)}):s(e)}function s(e){if(t[e])return t[e];var n=new Image;n.onload=function(){t[e]=n,u()&&r.forEach(function(e){e()})},t[e]=!1,n.src=e}function o(e){return t[e]}function u(){var e=!0;for(var n in t)t.hasOwnProperty(n)&&!t[n]&&(e=!1);return e}function a(e){r.push(e)}var t={},n=[],r=[];return{load:i,get:o,onReady:a,ready:u}}),define("../input",["require","./math"],function(e){function t(e){e.preventDefault()}function o(e,t){var i=e.keyCode;i in r?n[r[i]]=t:n[String.fromCharCode(i)]=t}function u(e){return n[e.toUpperCase()]}function a(){return u("SPACE")}function f(){function u(e){t(e),o({keyCode:32},!0),s.style.backgroundColor="#ccf"}function a(e){t(e),o({keyCode:32},!1),s.style.backgroundColor="#fcc"}var e=document.getElementsByClassName("dpad")[0],n=function(e){var t=e.clientWidth/2,n=e.clientHeight/2;while(e.offsetParent)t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;return vec2.createFrom(t,n)}(e),r=function(e){var t=e.clientWidth/2+5,n=e.clientHeight/2+5;return vec2.createFrom(t,n)}(e);e.addEventListener("touchstart",function(n){t(n),e.style.backgroundColor="#ccf"},!0),e.addEventListener("touchmove",function(s){t(s);var o=s.changedTouches[0],u=vec2.createFrom(o.clientX,o.clientY);vec2.subtract(u,n,i),i[0]=bound(i[0],-r[0],r[0]),i[1]=bound(i[1],-r[1],r[1])},!0),e.addEventListener("touchend",function(r){t(r),e.style.backgroundColor="#fcc",i[0]=i[1]=0},!0);var s=document.getElementsByClassName("fire")[0];s.addEventListener("touchstart",u,!1),s.addEventListener("touchend",a,!1),s.addEventListener("touchleave",a,!1),s.addEventListener("touchcancel",a,!1)}e("./math");var n={},r={32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},i=vec2.createFrom(0,0),s={FIRE:!1};return window.addEventListener("touchstart",t,!0),window.addEventListener("touchmove",t,!0),document.addEventListener("keydown",function(e){o(e,!0)}),document.addEventListener("keyup",function(e){o(e,!1)}),{init:f,setKey:o,isDown:u,dpadOffset:i,isFiring:a}}),define("../object",[],function(){function e(t,n,r){var i=Object.create(t.prototype),s=/xyz/.test(function(){xyz})?/\bparent\b/:/.*/;r=r||{};for(var o in r){var u=r[o],a=i[o];typeof a=="function"&&typeof u=="function"&&s.test(u)?i[o]=function(e,t){return function(){var n=this.parent;this.parent=t;var r=e.apply(this,arguments);return this.parent=n,r}}(u,a):i[o]=u}i.typename=n;var f=function(){i.init&&i.init.apply(this,arguments)};return f.prototype=i,f.prototype.constructor=f,f.extend=function(t,n){return typeof t=="object"&&(n=t,t="anonymous"),e(f,t,n)},f}return e(Object,"Object",{})}),define("../sceneobject",["require","./object"],function(e){var t=e("./object");return t.extend({init:function(e,t,n){this.pos=vec2.create(e||[0,0]),this.size=vec2.create(t||[1,1]),this.sprite=n},update:function(e){this.sprite&&this.sprite.update(e)},render:function(e){this.sprite&&this.sprite.render(e)},remove:function(){this._scene&&this._scene.removeObject(this)}})}),define("../sprite",["require","./resources","./object"],function(e){var t=e("./resources"),n=e("./object");return n.extend({init:function(e,t,n,r,i,s){this.pos=t,this.size=n,this.speed=typeof r=="number"?r:6,this.frames=i,this._index=0,this.url=e,this.scale=vec2.create([1,1]),this.dir=s||"horizontal"},update:function(e){this._index+=this.speed*e},setScale:function(e){this.scale=e},flipHorizontal:function(e){this.flipHoriz=e},getNumFrames:function(){return this.speed===0?1:this.frames?this.frames.length:Math.floor(t.get(this.url).width/this.size[0])},render:function(e,n){var r,i=this.getNumFrames();n=n||this.size,this.frames?r=this.frames[Math.floor(this._index)%i]:r=Math.floor(this._index%i);var s=this.pos[0],o=this.pos[1];this.dir=="vertical"?o+=r*this.size[1]:s+=r*this.size[0],e.drawImage(t.get(this.url),s,o,Math.min(this.size[0],n[0]),Math.min(this.size[1],n[1]),0,0,Math.min(this.size[0],n[0]),Math.min(this.size[1],n[1]))}})}),define("../units",["require","./sceneobject","./sprite","./input","./resources"],function(e){var t=e("./sceneobject"),n=e("./sprite"),r=e("./input"),i=e("./resources"),s=t.extend({init:function(e,t){this.parent(t,[18,18],new n("img/bosses.png",[211,483],[27,19],3,[0,1])),this._renderer=e,this.lastShot=0,this.score=0,this._scoreEl=document.getElementsByClassName("score")[0]},update:function(e){this.pos[0]+=20*e,r.isDown("w")&&(this.pos[1]-=250*e),r.isDown("a")&&(this.pos[0]-=250*e),r.isDown("s")&&(this.pos[1]+=250*e),r.isDown("d")&&(this.pos[0]+=250*e),r.isFiring()&&this.shoot(),this.pos[0]+=r.dpadOffset[0]*30*e,this.pos[1]+=r.dpadOffset[1]*30*e;var t=this._scene.camera.pos[0],n=this._renderer.width+t-this.size[0],i=this._renderer.height-this.size[1];this.pos[0]=bound(this.pos[0],t,n),this.pos[1]=bound(this.pos[1],0,i),this._scoreEl.textContent=this.score,this.parent(e)},shoot:function(){Date.now()-this.lastShot>100&&(this._scene.addObject(new o(this._renderer,[this.pos[0]+this.size[0],this.pos[1]+this.size[1]/2])),this.lastShot=Date.now())},hit:function(e){this.remove()},incrementScore:function(e){this.score+=e,this.score<0&&(this.score=0)},collide:!0,id:"player"}),o=t.extend({init:function(e,t){this.parent(t,[10,5]),this._renderer=e},update:function(e){this.pos[0]+=1e3*e;var t=this._scene.camera.pos[0],n=this._renderer.width+t-this.size[0];this.pos[0]>=n&&this.remove()},render:function(e){e.fillRect(0,0,10,5)},onCollide:function(e){if(e instanceof a){var t=this._scene.getObject("player");t&&t.incrementScore(e.points),e.remove(),this.remove()}},collide:!0}),u=o.extend({update:function(e){this.pos[0]-=300*e,this.pos[0]<this._scene.camera.pos[0]-this.size[0]&&this.remove()},onCollide:function(e){e instanceof s&&(e.hit(this),this.remove())},collide:!0}),a=t.extend({init:function(e,t,n,r){this._renderer=e,this.parent(t,n,r)},update:function(e){this.parent(e),this.pos[0]<this._scene.camera.pos[0]-this.size[0]&&this.remove()},onCollide:function(e){e instanceof s&&(e.hit(this),this.remove())},points:0}),f=a.extend({init:function(e,t){this.parent(e,t,[35,50],new n("img/bosses.png",[323,516],[40,50],2,[0,1])),this._startY=t[1],this._age=0},update:function(e){this.parent(e),this._age+=e;var t=Math.sin(this._age*2)*30;this.pos[1]=this._startY+t},points:300}),l=a.extend({init:function(e,t){this.parent(e,t,[35,50],new n("img/bosses.png",[3,154],[40,35],6,[0,1,2,3])),this.lastShot=0},shoot:function(){Date.now()-this.lastShot>500&&this.pos[0]<this._renderer.width+this._scene.camera.pos[0]&&this._scene.addObject(new u(this._renderer,[this.pos[0]-10,this.pos[1]+this.size[1]/2]))},update:function(e){this.parent(e),Math.random()<.005&&this.shoot()},points:100}),c=l.extend({update:function(e){this.pos[0]-=30*e,this.parent(e)}}),h=t.extend({init:function(e){var t=[e.width+16,e.height];this.parent(null,t,new n("img/dungeon.png",[333,897],[16,16],0));var r=this;e.onResize(function(e,t){r.size[0]=e+sprite.size[0],r.size[1]=t})},update:function(e){this.sprite.update(e);var t=this._scene.getScreenPos(this.pos),n=this.sprite.size[0];t[0]<-n&&(this.pos[0]+=-t[0])},render:function(e){this.pattern||(this.pattern=e.createPattern(i.get("img/floor.png"),"repeat")),e.fillStyle=this.pattern,e.fillRect(0,0,this.size[0],this.size[1])}});return{Player:s,Laser:o,EnemyLaser:u,Enemy:a,Boss:f,Mook:l,MovingMook:c,Floor:h}}),define("../level",["require","./units"],function(e){function n(e,n){e.addObject(new t.Floor(n));var r=new t.Boss(n,[200,0]);e.addObject(r),r=new t.Boss(n,[200,100]),e.addObject(r),r=new t.Boss(n,[200,200]),e.addObject(r);var i=n.height/2,s=i-25;for(var o=0;o<400;o++)r=new t.Mook(n,[300+o*30,i-Math.sin(o/10)*s]),e.addObject(r);for(var o=0;o<30;o++)r=new t.MovingMook(n,[600+o*60,i+Math.cos(o/5)*s/2]),e.addObject(r);var u=new t.Player(n,[50,50]);e.addObject(u)}var t=e("./units");return{init:n}});var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();define("../renderer",["require","./object"],function(e){var t=e("./object");return t.extend({init:function(e,t){var n=document.getElementById("canvas");this.width=n.width=e,this.height=n.height=t,this.ctx=n.getContext("2d"),this.canvas=n,this.resizeFuncs=[];var r=this;window.onresize=function(){var e=window.innerWidth/2,t=window.innerHeight/2;r.width=r.canvas.width=e,r.height=r.canvas.height=t,r.fireResize()}},onResize:function(e){this.resizeFuncs.push(e)},fireResize:function(){for(var e=0,t=this.resizeFuncs.length;e<t;e++)this.resizeFuncs[e](this.width,this.height)},render:function(e){if(!e.camera){console.log("WARNING! No camera in the scene, so nothing will be displayed.");return}var t=this.ctx;t.setTransform(1,0,0,1,0,0),t.fillStyle="black",t.fillRect(0,0,this.width,this.height),e.camera.prerender(t);var n=e.objects;for(var r=0,i=n.length;r<i;r++){var s=n[r];t.save(),t.translate(s.pos[0],s.pos[1]),t.fillStyle="pink",s.render(t),t.restore()}},debug:function(e){if(!e.camera){console.log("WARNING! No camera in the scene, so nothing will be displayed.");return}var t=this.ctx;t.setTransform(1,0,0,1,0,0),t.strokeStyle="red",e.camera.prerender(t);var n=e.objects;for(var r=0,i=n.length;r<i;r++){var s=n[r];t.strokeRect(s.pos[0],s.pos[1],s.size[0],s.size[1])}}})}),define("../scene",["require","./object"],function(e){function n(e,t,n,r,i,s,o,u){return!(n<=i||e>o||r<=s||t>u)}var t=e("./object");return t.extend({init:function(e){this.objects=[],this.objectsById={},this.camera=e},addObject:function(e){this.objects.push(e),e._scene=this,e.id&&(this.objectsById[e.id]=e)},getObject:function(e){return this.objectsById[e]},removeObject:function(e){var t=this.objects.indexOf(e);t!==-1&&(this.objects.splice(t,1),e._scene=null,e.id&&(this.objectsById[e.id]=null))},getScreenPos:function(e){var t=vec2.create();return vec2.subtract(e,this.camera.pos,t),t},update:function(e){this.camera.update(e);var t=this.objects;for(var n=t.length-1;n>=0;n--)t[n].update(e);this.checkCollisions()},checkCollisions:function(){var e=this.objects;for(var t=0,n=e.length;t<n;t++)e[t]&&e[t].collide&&this.checkObjCollisions(e[t])},checkObjCollisions:function(e){var t=this.objects;for(var r=0,i=t.length;r<i;r++){var s=e.pos,o=e.size;if(t[r]&&t[r]!=e){var u=t[r],a=u.pos,f=u.size;n(s[0],s[1],s[0]+o[0],s[1]+o[1],a[0],a[1],a[0]+f[0],a[1]+f[1])&&(e.onCollide&&e.onCollide(u),u.onCollide&&u.onCollide(e))}}}})}),define("../camera",["require","./sceneobject"],function(e){var t=e("./sceneobject");return t.extend({update:function(e){this.pos[0]+=20*e},prerender:function(e){e.translate(-this.pos[0],-this.pos[1])}})}),define("../app",["require","receiptverifier","./install-button","./math","./resources","./input","./level","./renderer","./scene","./camera"],function(e){function f(){var e=new o;u=new i(window.innerWidth/2,window.innerHeight/2),a=new s(e),r.init(a,u),n.init(),c()}function c(){l||(l=Date.now());var e=Date.now(),t=(e-l)/1e3;a.update(t),u.render(a),l=e,requestAnimFrame(c)}e("receiptverifier"),e("./install-button"),e("./math");var t=e("./resources"),n=e("./input"),r=e("./level"),i=e("./renderer"),s=e("./scene"),o=e("./camera"),u,a,l;t.load(["img/bosses.png","img/dungeon.png","img/floor.png"]),t.onReady(f)})